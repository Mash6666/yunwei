<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç ç¼–è¾‘åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        textarea { width: 100%; height: 100px; margin: 10px 0; font-family: monospace; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ä»£ç ç¼–è¾‘åŠŸèƒ½æµ‹è¯•</h1>

        <div class="test-section">
            <h3>1. æµ‹è¯•APIè¿æ¥</h3>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="connection-result"></div>
        </div>

        <div class="test-section">
            <h3>2. è·å–ä¿®å¤æ–¹æ¡ˆ</h3>
            <button onclick="getFixPlans()">è·å–ä¿®å¤æ–¹æ¡ˆ</button>
            <div id="fixplans-result"></div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•å‘½ä»¤ç¼–è¾‘</h3>
            <div>
                <label>æ–¹æ¡ˆID:</label>
                <input type="text" id="planId" value="plan_1" style="width: 200px; margin: 5px;">
            </div>
            <div>
                <label>å‘½ä»¤ç´¢å¼•:</label>
                <input type="number" id="commandIndex" value="0" style="width: 100px; margin: 5px;">
            </div>
            <div>
                <label>æ–°å‘½ä»¤:</label>
                <textarea id="newCommand" placeholder="è¾“å…¥æ–°çš„Shellå‘½ä»¤...">top -b -n 1 | head -n 20</textarea>
            </div>
            <button onclick="testCommandEdit()">æµ‹è¯•ç¼–è¾‘</button>
            <div id="edit-result"></div>
        </div>

        <div class="test-section">
            <h3>4. æµ‹è¯•å®‰å…¨éªŒè¯</h3>
            <button onclick="testSecurity()">æµ‹è¯•å®‰å…¨éªŒè¯</button>
            <div id="security-result"></div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8001'; // ä½¿ç”¨8001ç«¯å£ï¼Œé‚£é‡Œæœ‰æ–°çš„ä»£ç 

        async function testConnection() {
            try {
                const response = await fetch(`${BASE_URL}/api/status`);
                const result = await response.json();
                document.getElementById('connection-result').innerHTML =
                    `<div class="success">âœ… è¿æ¥æˆåŠŸ - ç³»ç»ŸçŠ¶æ€: ${result.status}</div>`;
            } catch (error) {
                document.getElementById('connection-result').innerHTML =
                    `<div class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function getFixPlans() {
            try {
                const response = await fetch(`${BASE_URL}/api/fix-plans`);
                const result = await response.json();
                const html = result.success && result.fix_plans.length > 0 ?
                    `<div class="success">âœ… æ‰¾åˆ° ${result.count} ä¸ªä¿®å¤æ–¹æ¡ˆ</div>` :
                    `<div class="error">âŒ æ²¡æœ‰æ‰¾åˆ°ä¿®å¤æ–¹æ¡ˆ</div>`;
                document.getElementById('fixplans-result').innerHTML = html;
            } catch (error) {
                document.getElementById('fixplans-result').innerHTML =
                    `<div class="error">âŒ è·å–å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testCommandEdit() {
            const planId = document.getElementById('planId').value;
            const commandIndex = parseInt(document.getElementById('commandIndex').value);
            const newCommand = document.getElementById('newCommand').value;

            try {
                const response = await fetch(`${BASE_URL}/api/command/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plan_id: planId,
                        command_index: commandIndex,
                        new_command: newCommand,
                        original_command: 'top -b -n 1 | head -n 17'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('edit-result').innerHTML =
                        `<div class="success">âœ… ç¼–è¾‘æˆåŠŸ: ${result.message}</div>`;
                } else {
                    document.getElementById('edit-result').innerHTML =
                        `<div class="error">âŒ ç¼–è¾‘å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('edit-result').innerHTML =
                    `<div class="error">âŒ ç¼–è¾‘è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testSecurity() {
            const safeCommand = 'ps aux | head -10';
            const dangerousCommand = 'rm -rf /';

            const results = [];

            // æµ‹è¯•å®‰å…¨å‘½ä»¤
            try {
                const response = await fetch(`${BASE_URL}/api/command/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_id: 'test',
                        command_index: 0,
                        new_command: safeCommand
                    })
                });
                const result = await response.json();
                results.push(`å®‰å…¨å‘½ä»¤ "${safeCommand}": ${result.success ? 'âœ… é€šè¿‡' : 'âŒ æ‹’ç»'}`);
            } catch (error) {
                results.push(`å®‰å…¨å‘½ä»¤æµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            // æµ‹è¯•å±é™©å‘½ä»¤
            try {
                const response = await fetch(`${BASE_URL}/api/command/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_id: 'test',
                        command_index: 0,
                        new_command: dangerousCommand
                    })
                });
                const result = await response.json();
                results.push(`å±é™©å‘½ä»¤ "${dangerousCommand}": ${result.success ? 'âš ï¸ æ„å¤–é€šè¿‡' : 'âœ… æ­£ç¡®æ‹’ç»'}`);
            } catch (error) {
                results.push(`å±é™©å‘½ä»¤æµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            document.getElementById('security-result').innerHTML =
                `<div>${results.join('<br>')}</div>`;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>